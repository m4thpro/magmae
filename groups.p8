pico-8 cartridge // http://www.pico-8.com
version 18
__lua__
-- some group theory
-- by kisonecat

blocks = {}
frame = 0

function idle_animate(sprite, frame)
   if sprite == 3 then
      return 3 + 16*(flr(frame/10) % 4)
   end
   
   return sprite
end

function _init()
   for i = 0,15 do
      for j = 0,13 do
	 local b = mget(i,j)
	 if b != 1 then
	    add( blocks, { x = i*8, y = j*8, kind = b,
			   you = (b==0), top = 0, left = 0,
			   dx = 0, dy = 0,
			   push = fget( b, 0 ),
			   solid = fget( b, 1 ),
			   win = fget( b, 7 )
	    } )
	 end
      end
   end
end

function is_overlap(ax,ay,bx,by)
   if (abs(ax-bx) < 8 and abs(ay-by) < 8) then
      return true
   end

   return false
end

function try_to_move( mover )
   local stuck = false

   if (mover.push == false and mover.you == false) then
      return true
   end

   for block in all(blocks) do
      if mover != block then
	 if block.solid then
	    if is_overlap( mover.x + mover.dx, mover.y + mover.dy, block.x, block.y ) then
	       block.dx = mover.dx
	       block.dy = mover.dy
	       if try_to_move( block ) then
		  stuck = true
	       end
	    end
	 end
      end
   end

   return stuck
end

function _update()
   frame = frame + 1
   
   -- undo button
   if (btnp(4)) then
   end
   
   for block in all(blocks) do
      spr( block.kind, block.x, block.y, 1, 1 )
      
      -- Move in the desired direction
      if not try_to_move( block ) then
	 block.x = block.x + block.dx
	 block.y = block.y + block.dy
      end

      -- stop when we make it to a square
      if (block.x) % 8 == 0 then
	 block.dx = 0
      end
      if (block.y) % 8 == 0 then
	 block.dy = 0
      end

      if block.you then
	 if (block.dx == 0) and (block.dy == 0) then
	    local speed = 2
	    if (btnp(0)) then block.dx=-speed end
	    if (btnp(1)) then block.dx= speed end
	    if (btnp(2)) then block.dy=-speed end
	    if (btnp(3)) then block.dy= speed end
            
	    -- stay pointing in movement direction
	    if block.dx < 0 then
	       block.left = -1
	       block.top = 0
	    end
	    if block.dx > 0 then
	       block.left = 1
	       block.top = 0
	    end
	    
	    if block.dy < 0 then
	       block.top = -1
	       block.left = 0
	    end
	    if block.dy > 0 then
	       block.top = 1
	       block.left = 0
	    end
	 end
      end
   end
      

end


function _draw()
   camera (0, 0)
   rectfill (0,0,127,127,3)

   pal(13,0)
   for block in all(blocks) do
      if block.you then
      	 local moving = 0
	 if block.dx != 0 or block.dy != 0 then
	    moving = frame % 2
	 end
	 if block.top != 0 then
	    spr(16 + 32*moving, block.x, block.y, 1, 1, block.left < 0, block.top > 0)
	 else
	    spr(0 + 32*moving, block.x, block.y, 1, 1, block.left < 0, block.top > 0)
	 end
      else
	 spr( idle_animate(block.kind, frame), block.x, block.y, 1, 1 )
      end
   end
end


__gfx__
94009494333333335655555500000000888888880009990000000000000000000000000000000000000000000000000000000000000000000000000000000000
49009d9d333333335655555500577000888888880999999000000000000000000000000000000000000000000000000000000000000000000000000000000000
940097e7333333336666666600577770888888889949449400000000000000000000000000000000000000000000000000000000000000000000000000000000
49009999333333335555565500577770888888889494444500000000000000000000000000000000000000000000000000000000000000000000000000000000
94949490333333335555565500500770888888889944944500000000000000000000000000000000000000000000000000000000000000000000000000000000
09949490333333335555565500500000888888889944495000000000000000000000000000000000000000000000000000000000000000000000000000000000
099999903333333366666666dd500000888888880994445000000000000000000000000000000000000000000000000000000000000000000000000000000000
07000070333333335655555500000000888888880009450000000000000000000000000000000000000000000000000000000000000000000000000000000000
4d790000333333330000000000000000cccccccc0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
99e99997333333330000000000577770cccccccc0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
4d794490333333330000000000577770cccccccc0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
99999990333333330000000000577770cccccccc0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00004490333333330000000000500000cccccccc0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00009990333333330000000000500000cccccccc0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
494949973333333300000000dd500000cccccccc0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
94949000333333330000000000000000cccccccc0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
94009494333333330000000000000770000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
49009d9d333333330000000000577770000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
940097e7333333330000000000577770000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
49009999333333330000000000577000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
94949490333333330000000000500000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
09949490333333330000000000500000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
909999093333333300000000dd500000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
70000007333333330000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
4d790097333333330000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
99e99900333333330000000000577770000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
4d794490333333330000000000577770000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
99999990333333330000000000577770000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00004490333333330000000000500000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00009990333333330000000000500000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
494949003333333300000000dd500000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
94949097333333330000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
__gff__
0000028003030000000000000000000000000080030000000000000000000000000000800000000000000000000000000000008000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
__map__
0202020202020202020202020202020200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0201010101020101010105050101030200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0201010101020105010505050101010200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0201010101020101050101050101010200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0201010101010101010104010101010200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0201010101010104010101010101010200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0201010001010101010104040101010200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0201010101010101010104010101010200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0202020102020202020202020202020200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0101010101010101010101010101010100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0101010101010404040101010101010100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0101010101010401040401010101010100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0101010101010404040401010101010100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0101010101010101010101010101010100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
